AWSTemplateFormatVersion: 2010-09-09
Description: DMS Automation Network stack which creates the Endpoints and Replication
  Instances.
Metadata:
  LICENSE: Apache License Version 2.0
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: DMS Replication Instance Configuration
        Parameters:
          - Subnets
          - SecurityGroup
          - InstanceType
          - EngineVersion
          - PublicAccess
          - MultiAz
      - Label:
          default: Source Database Configuration
        Parameters:
          - SourceDBName
          - SourceEngine
          - SourcePassword
          - SourcePort
          - SourceEndpointServer
          - SourceUser
      - Label:
          default: Target Database Configuration
        Parameters:
          - TargetDBName
          - TargetEngine
          - TargetPassword
          - TargetPort
          - TargetEndpointServer
          - TargetUser
      - Label:
          default: Lambda Layer Configuration
        Parameters:
          - LayerBucket
          - LayerKey
    ParameterLabels:
      LayerBucket:
        default: Layer S3 Bucket
      LayerKey:
        default: Layer S3 Key
      SourceDBName:
        default: Source Database Name
      SourceEngine:
        default: Source Database Engine
      SourcePassword:
        default: Source Database Password
      SourcePort:
        default: Source Database Port
      SourceEndpointServer:
        default: Source Database Endpoint
      SourceUser:
        default: Source Database Username
      TargetDBName:
        default: Target Database Name
      TargetEngine:
        default: Target Database Engine
      TargetPassword:
        default: Target Database Password
      TargetPort:
        default: Target Database Port
      TargetEndpointServer:
        default: Target Database Endpoint
      TargetUser:
        default: Target Database Username
      EngineVersion:
        default: Replication Engine Version
      InstanceType:
        default: Instance Type
      MultiAz:
        default: Enable MultiAZ
      PublicAccess:
        default: Allow Public Access
      SecurityGroup:
        default: Security Group
      Subnets:
        default: Subnet IDs
Parameters:
  EngineVersion:
    AllowedValues:
      - 3.1.3
      - 2.4.5
      - 2.4.4
      - 2.4.3
    Description: DMS replication engine version
    Type: String
  InstanceType:
    AllowedValues:
      - dms.t2.micro
      - dms.t2.small
      - dms.t2.medium
      - dms.t2.large
      - dms.c4.large
      - dms.c4.xlarge
      - dms.c4.2xlarge
      - dms.c4.4xlarge
    Description: DMS replication instance type
    Type: String
  MultiAz:
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'false'
    Description: Enable MultiAZ
    Type: String
  PublicAccess:
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'false'
    Description: Publicly Accessible
    Type: String
  SecurityGroup:
    Description: 'Security group ID for DMS replication instance (e.g., sg-1234abcd)'
    Type: 'AWS::EC2::SecurityGroup::Id'
  Subnets:
    Description: Choose two subnets in different availability zones (e.g., subnet-1234abcd,
      subnet-abcd1234)
    Type: 'List<AWS::EC2::Subnet::Id>'
  SourceDBName:
    Type: String
    Description: Name of the database in source server
  SourceEngine:
    Type: String
    Description: Database engine running on the source
    AllowedValues:
      - mysql
      - oracle
      - postgres
      - mariadb
      - aurora
      - aurora-postgresql
      - redshift
      - db2
      - azuredb
      - sybase
      - sqlserver
  SourcePassword:
    Type: String
    Description: Source database password
    NoEcho: 'true'
  SourcePort:
    Type: String
    Description: Port on which the source database is running
  SourceEndpointServer:
    Type: String
    Description: Source database hostname, endpoint URL or IP address
  SourceUser:
    Type: String
    Description: Source database user name
  TargetDBName:
    Type: String
    Description: Name of the database in target server
  TargetEngine:
    Type: String
    Description: Database engine running on the target
    AllowedValues:
      - mysql
      - oracle
      - postgres
      - mariadb
      - aurora
      - aurora-postgresql
      - redshift
      - db2
      - azuredb
      - sybase
      - sqlserver
  TargetPassword:
    Type: String
    Description: Target database password
    NoEcho: 'true'
  TargetPort:
    Type: String
    Description: Port on which the target database is running
  TargetEndpointServer:
    Type: String
    Description: Target database hostname, endpoint URL or IP address
  TargetUser:
    Type: String
    Description: Target database user name
  LayerBucket:
    Type: String
    Description: S3 bucket of the packaged zip file eampole (test-bucket-1234)
  LayerKey:
    Type: String
    Description: S3 location of the packaged zip file example (folder/sub-folder/test.zip)
Resources:
  ReplicationInstance:
    Properties:
      EngineVersion: !Ref EngineVersion
      MultiAZ: !Ref MultiAz
      PubliclyAccessible: !Ref PublicAccess
      ReplicationInstanceClass: !Ref InstanceType
      ReplicationSubnetGroupIdentifier: !Ref ReplicationSubnetGroup
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-ReplicationSetup'
        - Key: Product
          Value: DMS-Automation-ReplicationSetup
        - Key: Solution
          Value: DMS-Automation-ReplicationSetup
      VpcSecurityGroupIds:
        - !Ref SecurityGroup
    Type: 'AWS::DMS::ReplicationInstance'
  SourceEndpoint:
    Type: 'AWS::DMS::Endpoint'
    Properties:
      DatabaseName: !Ref SourceDBName
      EndpointType: source
      EngineName: !Ref SourceEngine
      Password: !Ref SourcePassword
      Port: !Ref SourcePort
      ServerName: !Ref SourceEndpointServer
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-ReplicationSetup'
        - Key: Product
          Value: DMS-Automation-ReplicationSetup
        - Key: Solution
          Value: DMS-Automation-ReplicationSetup
      Username: !Ref SourceUser
  TargetEndpoint:
    Type: 'AWS::DMS::Endpoint'
    Properties:
      DatabaseName: !Ref TargetDBName
      EndpointType: target
      EngineName: !Ref TargetEngine
      Password: !Ref TargetPassword
      Port: !Ref TargetPort
      ServerName: !Ref TargetEndpointServer
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-ReplicationSetup'
        - Key: Product
          Value: DMS-Automation-ReplicationSetup
        - Key: Solution
          Value: DMS-Automation-ReplicationSetup
      Username: !Ref TargetUser
  ReplicationSubnetGroup:
    Properties:
      ReplicationSubnetGroupDescription: DMS Automation Subnets
      SubnetIds: !Ref Subnets
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-ReplicationSetup'
        - Key: Product
          Value: DMS-Automation-ReplicationSetup
        - Key: Solution
          Value: DMS-Automation-ReplicationSetup
    Type: 'AWS::DMS::ReplicationSubnetGroup'
  CheckEndpointConnection:
    Type: 'Custom::DmsEndpointConnectionTester'
    Properties:
      ServiceToken: !GetAtt 
        - DmsEndpointConnTest
        - Arn
      SourceArn: !Ref SourceEndpoint
      TargetArn: !Ref TargetEndpoint
      ReplicationInstanceArn: !Ref ReplicationInstance
  DmsEndpointConnTestRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
      Path: /
      Policies:
        - PolicyName: dms-connection-access
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - 'dms:DescribeConnections'
                  - 'dms:TestConnection'
                Resource: '*'
  DmsEndpointConnTestLayer:
    Type: 'AWS::Lambda::LayerVersion'
    Properties:
      CompatibleRuntimes:
        - python3.6
        - python3.7
      Content:
        S3Bucket: !Ref LayerBucket
        S3Key: !Ref LayerKey
      Description: Latest boto3 layer for DMS wait handler
  DmsEndpointConnTest:
    Type: 'AWS::Lambda::Function'
    Properties:
      Description: Checks the connection between DMS replication instance and DMS endpoint
      Handler: index.lambda_handler
      Runtime: python3.6
      Role: !GetAtt 
        - DmsEndpointConnTestRole
        - Arn
      Timeout: 600
      Layers:
        - !Ref DmsEndpointConnTestLayer
      Code:
        ZipFile: | 
          import cfnresponse
          import json
          import boto3
          def lambda_handler(event, context):  
             rep_arn = event['ResourceProperties']['ReplicationInstanceArn'] 
             source_arn = event['ResourceProperties']['SourceArn'] 
             target_arn = event['ResourceProperties']['TargetArn'] 
             responseData = {} 
          
             try: 
                 if event['RequestType'] == 'Delete': 
                     print('Nothing will be done on DeleteStack call') 
                 else: 
                     print('This is a %s event' %(event['RequestType'])) 
                     source_status = dms_status(source_arn,rep_arn) 
                     target_status = dms_status(target_arn,rep_arn) 
                     if 'successful' in source_status: 
                         print('Source endpoint was successfully tested') 
                         if 'successful' in target_status: 
                             print('Target endpoint was successfully tested') 
                         else: 
                             print('Target endpoint was not tested. Please test connection with replication instance') 
                     else: 
                         print('Source endpoint was not tested. Please test connection with replication instance.') 
                 cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, '') 
             except Exception as e: 
                 print(e) 
                 cfnresponse.send(event, context, cfnresponse.FAILURE, {}, '')
          
          def dms_status(endpoint, rep_inst):
              try:
                  dms_client = boto3.client('dms')
                  response = dms_client.describe_connections(
                  Filters=[
                      {
                          'Name': 'endpoint-arn',
                          'Values': [endpoint]
                      },
                      {
                          'Name': 'replication-instance-arn',
                          'Values': [rep_inst]
                      }
                      ]
                  )
                  e = response['Connections'][0]['Status']
              except Exception as e:
                  print('Error occured with replication instance: %s and endpoint: %s' %(endpoint,rep_inst))
                  print ('Exception is %s' %(e))
              return e
